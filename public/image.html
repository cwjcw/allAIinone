<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>画图 - OpenRouter</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #f8fbff 0%, #eef2f7 100%);
      --card: #ffffff;
      --border: #e5e7eb;
      --primary: #0f766e;
      --primary-2: #14b8a6;
      --text: #0f172a;
      --muted: #475569;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family:"Inter","Segoe UI","PingFang SC","Microsoft YaHei",sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; background:rgba(255,255,255,0.9); backdrop-filter:blur(12px); box-shadow:0 8px 30px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
    header a { text-decoration:none; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text); }
    main { max-width:1040px; margin:24px auto; background:var(--card); border:1px solid var(--border); border-radius:18px; padding:24px; box-shadow:0 18px 50px rgba(15, 118, 110, 0.08); }
    label { display:block; margin:12px 0 6px; font-weight:650; color:var(--muted); letter-spacing:0.01em; }
    select, textarea, button, input[type="text"] { width:100%; box-sizing:border-box; }
    textarea, input[type="text"] { padding:12px; border-radius:12px; border:1px solid var(--border); font-size:14px; background:#f9fafb; }
    textarea:focus, input[type="text"]:focus, select:focus { outline:2px solid rgba(20,184,166,0.25); border-color:var(--primary-2); background:#fff; }
    select { padding:12px; border-radius:12px; border:1px solid var(--border); background:#f9fafb; }
    button { margin-top:14px; padding:13px; border:none; border-radius:12px; background:linear-gradient(120deg, var(--primary), var(--primary-2)); color:#fff; font-weight:750; cursor:pointer; letter-spacing:0.02em; box-shadow:0 10px 24px rgba(20,184,166,0.25); }
    button:hover { transform:translateY(-1px); box-shadow:0 14px 28px rgba(20,184,166,0.28); }
    .output { margin-top:16px; padding:14px; background:#0f172a; color:#e5e7eb; border-radius:14px; min-height:64px; }
    img { max-width:100%; margin-top:12px; border-radius:14px; border:1px solid var(--border); box-shadow:0 10px 26px rgba(15,23,42,0.12); }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .row-4 { display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; }
    @media (max-width:760px){ .row{ grid-template-columns:1fr; } .row-4{ grid-template-columns:1fr; } main{ margin:12px; padding:18px; } }
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { padding:8px 10px; background:#f1f5f9; border:1px solid var(--border); border-radius:10px; font-size:13px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div><strong>画图 - OpenRouter</strong></div>
    <a href="/web/index.html">返回首页</a>
  </header>
  <main>
    <div class="row">
      <div>
        <label>模型（支持图片的将优先显示）</label>
        <select id="image-model"></select>
      </div>
      <div>
        <label>提示词</label>
        <textarea id="image-prompt" placeholder="描述你想要的画面..."></textarea>
      </div>
    </div>

    <label style="margin-top:6px;">参考图片 URL（最多 4 条）</label>
    <div class="row-4">
      <input id="image-url-1" type="text" placeholder="URL 1" />
      <input id="image-url-2" type="text" placeholder="URL 2" />
      <input id="image-url-3" type="text" placeholder="URL 3" />
      <input id="image-url-4" type="text" placeholder="URL 4" />
    </div>

    <label style="margin-top:10px;">上传本地图片（最多 4 张，自动重命名为 图片1-图片4）</label>
    <input id="image-file" type="file" accept="image/*" multiple style="width:100%; padding:6px 0;" />
    <div id="file-list" class="chips"></div>

    <button id="image-send">生成图片</button>
    <div class="output" id="image-output">等待输入...</div>
    <img id="image-preview" alt="">
    <div style="margin-top:8px;">
      <a id="image-download" href="#" download="image.png" style="display:none;">下载图片</a>
    </div>
  </main>

  <script>
    const state = { models: [] };
    function setOutput(text) { document.getElementById("image-output").textContent = text; }

    async function fetchModels() {
      const res = await fetch("/api/models");
      if (!res.ok) throw new Error("获取模型失败");
      const data = await res.json();
      state.models = data.data || [];
      const imageModels = state.models.filter(m => m.supports_image);
      const select = document.getElementById("image-model");
      select.innerHTML = "";
      (imageModels.length ? imageModels : state.models).forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.id;
        select.appendChild(opt);
      });
    }

    function readFileBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const res = reader.result || "";
          const prefix = "base64,";
          const pos = res.indexOf(prefix);
          if (pos >= 0) {
            resolve(res.slice(pos + prefix.length));
          } else {
            resolve(res.toString());
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderFileNames(files) {
      const list = document.getElementById("file-list");
      list.innerHTML = "";
      Array.from(files)
        .slice(0, 4)
        .forEach((file, idx) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.textContent = `图片${idx + 1} · ${file.name}`;
          list.appendChild(chip);
        });
    }

    document.getElementById("image-file").addEventListener("change", (e) => {
      renderFileNames(e.target.files || []);
    });

    async function sendImage() {
      setOutput("生成中...");
      const model = document.getElementById("image-model").value;
      const prompt = document.getElementById("image-prompt").value.trim();
      const urlInputs = [
        document.getElementById("image-url-1").value.trim(),
        document.getElementById("image-url-2").value.trim(),
        document.getElementById("image-url-3").value.trim(),
        document.getElementById("image-url-4").value.trim(),
      ].filter(Boolean);
      const files = document.getElementById("image-file").files || [];
      const limitedFiles = Array.from(files).slice(0, 4);
      const b64_list = [];
      for (const f of limitedFiles) {
        b64_list.push(await readFileBase64(f));
      }

      if (!prompt && urlInputs.length === 0 && b64_list.length === 0) {
        setOutput("请输入提示词或提供图片");
        return;
      }
      try {
        const body = { model, prompt, size: "1024x1024" };
        if (urlInputs.length === 1) body.image_url = urlInputs[0];
        if (urlInputs.length > 1) body.image_url_list = urlInputs.slice(0, 4);
        if (b64_list.length === 1) body.image_b64 = b64_list[0];
        if (b64_list.length > 1) body.image_b64_list = b64_list;
        const res = await fetch("/api/image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        const b64 = data?.data?.[0]?.b64_json;
        const img = document.getElementById("image-preview");
        const dl = document.getElementById("image-download");
        if (b64) {
          img.src = "data:image/png;base64," + b64;
          setOutput("图片生成成功");
          dl.href = img.src;
          dl.style.display = "inline";
        } else {
          alert(data?.detail || "图片生成失败");
          setOutput("");
        }
      } catch (err) {
        alert(`图片请求失败：${err}`);
        setOutput("");
      }
    }

    document.getElementById("image-send").onclick = sendImage;
    fetchModels().catch(e=>alert(e));
  </script>
</body>
</html>
